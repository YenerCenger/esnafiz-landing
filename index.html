import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:esnafiz/providers/cart_provider.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:mobile_scanner/mobile_scanner.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:esnafiz/core/controllers/scanner_controller.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:esnafiz/models/sold_product.dart';
import 'package:esnafiz/core/utils/snackbar_utils.dart';
import 'package:esnafiz/core/widgets/white_box.dart';

class SaleScannerScreen extends ConsumerStatefulWidget {
  const SaleScannerScreen({super.key});

  @override
  ConsumerState<SaleScannerScreen> createState() => _SaleScannerScreenState();
}

class _SaleScannerScreenState extends ConsumerState<SaleScannerScreen> {
  bool _isScanned = false;
  bool _isInitialized = false;

  Future<bool> _checkCameraPermission() async {
    final status = await Permission.camera.status;
    if (status.isGranted) {
      return true;
    }
    final result = await Permission.camera.request();
    return result.isGranted;
  }

  @override
  void initState() {
    super.initState();
    _initializeScanner();
  }

  Future<void> _initializeScanner() async {
    if (await _checkCameraPermission()) {
      try {
        // Daha hƒ±zlƒ± ba≈ülatma - gereksiz dispose'u kaldƒ±r
        await ScannerController.initialize();

        if (mounted) {
          setState(() {
            _isInitialized = true;
          });
        }

        print('‚úÖ Scanner ba≈üarƒ±yla ba≈ülatƒ±ldƒ±');
      } catch (e) {
        print('‚ùå Scanner initialization error: $e');
        if (mounted) {
          SnackBarUtils.showError(context, 'Kamera ba≈ülatƒ±lamadƒ±');
        }
      }
    } else {
      if (mounted) {
        SnackBarUtils.showError(context, 'Kamera izni gerekli');
      }
    }
  }

  @override
  void dispose() {
    // Daha hƒ±zlƒ± dispose - buffer temizlemeyi kaldƒ±r
    ScannerController.dispose();
    ref.read(cartProvider.notifier).clear();
    super.dispose();
  }

  Future<Map<String, dynamic>?> _findProduct(String barcode) async {
    // Aktif d√ºkkan ID'sini al
    SharedPreferences prefs = await SharedPreferences.getInstance();
    String? activeStoreId = prefs.getString('activeStoreId');

    if (activeStoreId == null) {
      throw Exception('Aktif maƒüaza bulunamadƒ±');
    }

    // Sadece aktif d√ºkkana ait √ºr√ºnleri ara
    final productQuery = await FirebaseFirestore.instance
        .collection('items')
        .where('barcode', isEqualTo: barcode)
        .where('storeId', isEqualTo: activeStoreId)
        .get();

    if (productQuery.docs.isNotEmpty) {
      return productQuery.docs.first.data();
    }

    final cartItems = ref.read(cartProvider).items;
    final cartProduct = cartItems.firstWhere(
      (item) => item['barcode']?.toString() == barcode,
      orElse: () => {},
    );

    if (cartProduct.isNotEmpty) {
      return cartProduct;
    }

    return null;
  }

  Future<void> _onBarcodeDetected(String code) async {
    if (_isScanned || !_isInitialized) return;
    _isScanned = true;

    try {
      final product = await _findProduct(code);

      if (product != null) {
        if (mounted) {
          final cartItem = {
            'name': product['name'],
            'price': product['price'],
            'purchase_price': product['purchase_price'] ?? 0.0,
            'barcode': code,
          };
          print(
              'üõí Sepete ekleniyor: ${product['name']} - Alƒ±≈ü fiyatƒ±: ‚Ç∫${product['purchase_price'] ?? 0.0}');
          ref.read(cartProvider.notifier).add(cartItem);

          SnackBarUtils.showSuccess(
              context, 'Sepete eklendi: ${product['name']}');
        }
      } else {
        if (mounted) {
          SnackBarUtils.showError(context, '√úr√ºn bulunamadƒ±');
        }
      }
    } catch (e) {
      if (mounted) {
        SnackBarUtils.showError(context, 'Bir hata olu≈ütu');
      }
    } finally {
      if (mounted) {
        setState(() {
          _isScanned = false;
        });
      }
    }
  }

  Future<void> _completeOrder() async {
    final cart = ref.read(cartProvider);
    final items = cart.items;
    if (items.isEmpty) return;

    final total = items.fold<double>(
      0,
      (sum, item) => sum + (item['price'] as num).toDouble(),
    );

    try {
      final userUid = FirebaseAuth.instance.currentUser?.uid;
      SharedPreferences prefs = await SharedPreferences.getInstance();
      String? activeStoreId = prefs.getString('activeStoreId');
      if (userUid == null) {
        throw Exception('Kullanƒ±cƒ± oturumu bulunamadƒ±');
      }
      if (activeStoreId == null) {
        throw Exception('Aktif maƒüaza bulunamadƒ±');
      }

      // Stok g√ºncelleme ve satƒ±lan √ºr√ºnleri kaydetme i≈ülemleri
      for (var item in items) {
        try {
          final productQuery = await FirebaseFirestore.instance
              .collection('items')
              .where('barcode', isEqualTo: item['barcode'])
              .where('storeId', isEqualTo: activeStoreId)
              .get();

          if (productQuery.docs.isEmpty) {
            throw Exception('√úr√ºn bulunamadƒ±: ${item['name']}');
          }

          final productDoc = productQuery.docs.first;
          final productData = productDoc.data();
          final currentStock = productData['stock'] ?? 0;
          final newStock = currentStock - (item['count'] ?? 1);

          if (newStock < 0) {
            throw Exception('Yetersiz stok: ${item['name']}');
          }

          // Stok g√ºncelle
          await productDoc.reference.update({
            'stock': newStock,
          });

          // Kritik stok kontrol√º
          final shouldNotify = newStock <= (productData['critical_stock'] ?? 5);

          // Bildirim: Stok g√ºncellendi
          await FirebaseFirestore.instance.collection('notifications').add({
            'type': 'stock_updated',
            'title': 'Stok G√ºncellendi!',
            'description': '${productData['name']} √ºr√ºn√ºn√ºn stoƒüu g√ºncellendi.',
            'user_id': productData['user_id'],
            'createdAt': FieldValue.serverTimestamp(),
          });

          if (shouldNotify) {
            await FirebaseFirestore.instance.collection('notifications').add({
              'type': 'low_stock',
              'title': 'Stok Kritik!',
              'description':
                  '${productData['name']} √ºr√ºn√ºn√ºn stoƒüu kritik seviyeye d√º≈üt√º. (Stok: $newStock)',
              'user_id': productData['user_id'],
              'createdAt': FieldValue.serverTimestamp(),
            });
          }

          // Satƒ±lan √ºr√ºn√º kaydet
          final soldProduct = SoldProduct(
            id: '', // Firestore will generate this
            name: item['name'],
            barcode: item['barcode'],
            price: item['price'],
            purchasePrice: item['purchase_price'] ?? 0.0,
            quantity: item['count'] ?? 1,
            soldDate: DateTime.now(),
            userId: userUid ?? '',
            category: productData['category'],
            description: productData['description'],
          );

          await SoldProduct.addSoldProduct(soldProduct);
        } catch (e) {
          print('√úr√ºn i≈üleme hatasƒ±: ${item['name']} - $e');
          throw Exception('√úr√ºn i≈ülenirken hata: ${item['name']} - $e');
        }
      }

      // Toplam alƒ±≈ü maliyetini hesapla
      double totalCost = 0;
      print('üîç Alƒ±≈ü maliyeti hesaplanƒ±yor...');
      for (var item in items) {
        final purchasePrice = (item['purchase_price'] ?? 0.0).toDouble();
        final quantity = (item['count'] ?? 1).toInt();
        final itemCost = purchasePrice * quantity;
        totalCost += itemCost;
        print(
            'üì¶ ${item['name']}: Alƒ±≈ü fiyatƒ±: ‚Ç∫$purchasePrice, Miktar: $quantity, Maliyet: ‚Ç∫$itemCost');
      }
      print('üí∞ Toplam alƒ±≈ü maliyeti: ‚Ç∫$totalCost');

      // ƒ∞≈ülem kaydƒ± (gelir)
      print('‚úÖ Satƒ±≈ü kaydƒ± olu≈üturuluyor...');
      final transactionRef =
          await FirebaseFirestore.instance.collection('transactions').add({
        'user_id': userUid,
        'title': 'Satƒ±≈ü',
        'category': 'Satƒ±≈ü',
        'amount': total,
        'items': items,
        'date': DateTime.now(),
        'created_at': FieldValue.serverTimestamp(),
        'storeId': activeStoreId,
        'createdAt': FieldValue.serverTimestamp(),
      });
      print('‚úÖ Satƒ±≈ü kaydƒ± olu≈üturuldu: ${transactionRef.id}');

      // Alƒ±≈ü maliyeti gider kaydƒ±
      if (totalCost > 0) {
        print('üí∏ Gider kaydƒ± olu≈üturuluyor... Maliyet: ‚Ç∫$totalCost');
        await FirebaseFirestore.instance.collection('transactions').add({
          'user_id': userUid,
          'title': 'Satƒ±lan √úr√ºnlerin Alƒ±≈ü Maliyeti',
          'category': 'Maliyet',
          'amount': -totalCost, // Negatif deƒüer gider olarak
          'items': items,
          'date': DateTime.now(),
          'created_at': FieldValue.serverTimestamp(),
          'storeId': activeStoreId,
          'createdAt': FieldValue.serverTimestamp(),
          'related_sale_id': transactionRef.id, // Satƒ±≈ü ile ili≈ükilendir
        });
        print('‚úÖ Gider kaydƒ± olu≈üturuldu');
      } else {
        print('‚ö†Ô∏è Alƒ±≈ü maliyeti 0 veya negatif, gider kaydƒ± olu≈üturulmadƒ±');
      }

      // Bildirim: Satƒ±≈ü tamamlandƒ±
      await FirebaseFirestore.instance.collection('notifications').add({
        'type': 'sale_completed',
        'title': 'Satƒ±≈ü Tamamlandƒ±!',
        'description':
            '‚Ç∫${total.toStringAsFixed(2)} tutarƒ±nda satƒ±≈ü tamamlandƒ±.',
        'user_id': userUid,
        'transactionId': transactionRef.id,
        'amount': total,
        'createdAt': FieldValue.serverTimestamp(),
      });

      ref.read(cartProvider.notifier).clear();
      if (mounted) {
        SnackBarUtils.showCompletion(context, 'Sipari≈ü tamamlandƒ±');
        Navigator.pop(context);
      }
    } catch (e) {
      print('Sipari≈ü tamamlama hatasƒ±: $e');
      if (mounted) {
        SnackBarUtils.showErrorWithAction(
          context,
          'Sipari≈ü tamamlanamadƒ±: ${e.toString()}',
          actionLabel: 'Tamam',
          onActionPressed: () {},
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    if (!_isInitialized) {
      return const Scaffold(
        body: Center(
          child: CircularProgressIndicator(),
        ),
      );
    }

    return WillPopScope(
      onWillPop: () async {
        ref.read(cartProvider.notifier).clear();
        return true;
      },
      child: Scaffold(
        resizeToAvoidBottomInset: false,
        backgroundColor: Theme.of(context).colorScheme.primary,
        appBar: AppBar(
          backgroundColor: Theme.of(context).colorScheme.primary,
          elevation: 0,
          title: const Text(
            'Barkod ile Satƒ±≈ü',
            style: TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
              fontSize: 20,
            ),
          ),
          centerTitle: true,
          leading: IconButton(
            icon: const Icon(Icons.arrow_back, color: Colors.white),
            onPressed: () {
              ref.read(cartProvider.notifier).clear();
              Navigator.pop(context);
            },
          ),
        ),
        body: Container(
          width: double.infinity,
          decoration: BoxDecoration(
            color: Theme.of(context).scaffoldBackgroundColor,
            borderRadius: BorderRadius.zero, // ‚úÖ Sƒ±fƒ±r radius
          ),
          padding: EdgeInsets.zero, // ‚úÖ Sƒ±fƒ±r padding
          child: Column(
            children: [
              // ‚úÖ √úST: Kamera (tam ekran)
              Expanded(
                flex: 3, // %60 alan
                child: LayoutBuilder(
                  builder: (context, constraints) {
                    print('üîç ===== LAYOUT BUILDER √áALI≈ûIYOR =====');
                    print(
                        'üì± Kamera alanƒ±: ${constraints.maxWidth}x${constraints.maxHeight}');
                    print('üîç WhiteBox edgeToEdge: true');
                    print('üîç Padding: EdgeInsets.zero');
                    print('üîç BorderRadius: BorderRadius.zero');

                    // ‚úÖ Dinamik tarama alanƒ± - ekran boyutuna g√∂re
                    final scanWidth =
                        constraints.maxWidth * 0.8; // %80 geni≈ülik
                    final scanHeight = scanWidth * 0.6; // 3:2 oranƒ±
                    final center = Offset(
                      constraints.maxWidth / 2,
                      constraints.maxHeight / 2,
                    );

                    print(
                        'üéØ Tarama alanƒ±: ${scanWidth.toInt()}x${scanHeight.toInt()}');
                    print(
                        'üìç Merkez: ${center.dx.toInt()}, ${center.dy.toInt()}');

                    return Stack(
                      fit: StackFit.expand, // ‚úÖ T√ºm alanƒ± kapla
                      children: [
                        MobileScanner(
                          controller: ScannerController.instance,
                          fit: BoxFit.cover,
                          onDetect: (capture) {
                            final List<Barcode> barcodes = capture.barcodes;
                            for (final barcode in barcodes) {
                              if (barcode.rawValue != null) {
                                _onBarcodeDetected(barcode.rawValue!);
                                break;
                              }
                            }
                          },
                        ),
                        // ‚úÖ Sadece kenarlarƒ± karartan overlay
                        CustomPaint(
                          painter: ScannerOverlayPainter(
                            scanArea: Rect.fromCenter(
                              center: center,
                              width: scanWidth,
                              height: scanHeight,
                            ),
                            borderColor: Theme.of(context).colorScheme.primary,
                          ),
                        ),
                        // Tarama √ßizgisi
                        Center(
                          child: SizedBox(
                            width: scanWidth,
                            height: scanHeight,
                            child: _BarcodeScanningLine(),
                          ),
                        ),
                      ],
                    );
                  },
                ),
              ),

              // ‚úÖ ALT: Sepet paneli (beyaz)
              Expanded(
                flex: 2, // %40 alan
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: const BorderRadius.vertical(
                      top: Radius.circular(20),
                    ),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 10,
                        offset: const Offset(0, -5),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      Text(
                        'Sepet',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).textTheme.bodyLarge?.color,
                        ),
                      ),
                      const SizedBox(height: 16),
                      Expanded(
                        child: Builder(
                          builder: (context) {
                            final cart = ref.watch(cartProvider);
                            if (cart.items.isEmpty) {
                              return Center(
                                child: Text(
                                  'Sepet bo≈ü',
                                  style: TextStyle(
                                    color: Theme.of(context)
                                        .textTheme
                                        .bodyMedium
                                        ?.color,
                                  ),
                                ),
                              );
                            }
                            return ListView.builder(
                              itemCount: cart.items.length,
                              itemBuilder: (context, index) {
                                final item = cart.items[index];
                                return ListTile(
                                  title: Text(item['name']),
                                  subtitle: Text(
                                    '‚Ç∫${item['price'].toStringAsFixed(2)}',
                                    style: TextStyle(
                                      color:
                                          Theme.of(context).colorScheme.primary,
                                    ),
                                  ),
                                  trailing: IconButton(
                                    icon: const Icon(Icons.delete),
                                    onPressed: () {
                                      ref
                                          .read(cartProvider.notifier)
                                          .remove(item);
                                    },
                                  ),
                                );
                              },
                            );
                          },
                        ),
                      ),
                      const SizedBox(height: 16),
                      ElevatedButton(
                        onPressed: _completeOrder,
                        style: ElevatedButton.styleFrom(
                          backgroundColor:
                              Theme.of(context).colorScheme.primary,
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: const Text(
                          'Sipari≈üi Tamamla',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _BarcodeScanningLine extends StatefulWidget {
  const _BarcodeScanningLine();

  @override
  State<_BarcodeScanningLine> createState() => _BarcodeScanningLineState();
}

class _BarcodeScanningLineState extends State<_BarcodeScanningLine>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    )..repeat(reverse: true);

    _animation = Tween<double>(begin: 0, end: 1).animate(_controller);
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return CustomPaint(
          painter: _ScanningLinePainter(
            progress: _animation.value,
            color: Theme.of(context).colorScheme.primary,
          ),
          child: Container(),
        );
      },
    );
  }
}

class _ScanningLinePainter extends CustomPainter {
  final double progress;
  final Color color;

  _ScanningLinePainter({
    required this.progress,
    required this.color,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..strokeWidth = 2;

    final y = size.height * progress;
    canvas.drawLine(
      Offset(0, y),
      Offset(size.width, y),
      paint,
    );
  }

  @override
  bool shouldRepaint(_ScanningLinePainter oldDelegate) {
    return oldDelegate.progress != progress || oldDelegate.color != color;
  }
}

class ScannerOverlayPainter extends CustomPainter {
  final Rect scanArea;
  final Color borderColor;

  ScannerOverlayPainter({
    required this.scanArea,
    required this.borderColor,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.black.withOpacity(0.5)
      ..style = PaintingStyle.fill;

    // ‚úÖ Sadece kenarlarƒ± karart - ortayƒ± bo≈ü bƒ±rak
    // √úst kƒ±sƒ±m
    canvas.drawRect(Rect.fromLTWH(0, 0, size.width, scanArea.top), paint);

    // Alt kƒ±sƒ±m
    canvas.drawRect(
        Rect.fromLTWH(
            0, scanArea.bottom, size.width, size.height - scanArea.bottom),
        paint);

    // Sol kƒ±sƒ±m
    canvas.drawRect(
        Rect.fromLTWH(0, scanArea.top, scanArea.left, scanArea.height), paint);

    // Saƒü kƒ±sƒ±m
    canvas.drawRect(
        Rect.fromLTWH(scanArea.right, scanArea.top, size.width - scanArea.right,
            scanArea.height),
        paint);

    // Kenarlƒ±k √ßiz
    final borderPaint = Paint()
      ..color = borderColor
      ..style = PaintingStyle.stroke
      ..strokeWidth = 4;

    canvas.drawRRect(
      RRect.fromRectAndRadius(
        scanArea,
        const Radius.circular(16),
      ),
      borderPaint,
    );
  }

  @override
  bool shouldRepaint(ScannerOverlayPainter oldDelegate) {
    return oldDelegate.scanArea != scanArea ||
        oldDelegate.borderColor != borderColor;
  }
}
